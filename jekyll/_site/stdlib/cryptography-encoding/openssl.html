


<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title> | </title>

        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/highlight.css">
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='/jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body>
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter">

              
              <li>
                <a href="/about-this-book.html"> About This Book</a>
              </li>
                
              
              <li>
                <a href="/language.html"> Language Structure</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/language/keywords.html"> Keywords</a>
                          </li>
                        
                          <li>
                            <a href="/language/literals.html"> Literals</a>
                          </li>
                        
                          <li>
                            <a href="/language/variables-constants.html"> Variables and Constants</a>
                          </li>
                        
                          <li>
                            <a href="/language/assignment.html"> Assignment</a>
                          </li>
                        
                          <li>
                            <a href="/language/control-expressions.html"> Control Expressions</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-def.html"> Defining methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-call.html"> Calling methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/modules-classes.html"> Modules and Classes</a>
                          </li>
                        
                          <li>
                            <a href="/language/exceptions.html"> Exceptions</a>
                          </li>
                        
                          <li>
                            <a href="/language/refinements.html"> Refinements</a>
                          </li>
                        
                          <li>
                            <a href="/language/precedence.html"> Precedence</a>
                          </li>
                        
                          <li>
                            <a href="/language/files.html"> File Structure</a>
                          </li>
                        
                          <li>
                            <a href="/language/globals.html"> Globals</a>
                          </li>
                        
                          <li>
                            <a href="/language/metaprogramming.html"> Metaprogramming</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/builtin.html"> Built-in Classes</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/builtin/core.html"> Language Core</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/types.html"> Value Types</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/errors-warnings.html"> Errors and Warnings</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/system-cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/concurrency-parallelism.html"> Concurrency and Parallelism</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/internals.html"> Interpreter Internals</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/marshal.html"> Marshal</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/random.html"> Random</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/stdlib.html"> Standard Library</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/stdlib/patterns.html"> Design Patterns</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/formats.html"> Formats</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/development-debugging.html"> Development and Debugging</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/string-utilities.html"> String Utilities</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/networking-web.html"> Networking and Web</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cryptography-encoding.html"> Cryptography and Encoding</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/misc.html"> Miscellaneous Libraries</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/advanced-topics.html"> Advanced Topics</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/advanced-topics/third-party-libraries.html"> Third-Party Libraries</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/tools-approaches.html"> Tools and Approaches</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/contributing.html"> Contributing To Ruby</a>
                          </li>
                        
                    </ul>
                
              

            </ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                 
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'openssl'</span>
</code></pre></div></div>

<h1 id="openssl">OpenSSL</h1>

<p>OpenSSL provides SSL, TLS and general purpose cryptography. It wraps the
<a href="https://www.openssl.org/">OpenSSL</a> library.</p>

<h1 id="examples">Examples</h1>

<p>All examples assume you have loaded OpenSSL with:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'openssl'</span>
</code></pre></div></div>

<p>These examples build atop each other. For example the key created in the
next is used in throughout these examples.</p>

<h2 id="keys">Keys</h2>

<h3 id="creating-a-key">Creating a Key</h3>

<p>This example creates a 2048 bit RSA keypair and writes it to the current
directory.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="mi">2048</span>

<span class="nb">open</span> <span class="s1">'private_key.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span> <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">key</span><span class="p">.</span><span class="nf">to_pem</span> <span class="k">end</span>
<span class="nb">open</span> <span class="s1">'public_key.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span> <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">key</span><span class="p">.</span><span class="nf">public_key</span><span class="p">.</span><span class="nf">to_pem</span> <span class="k">end</span>
</code></pre></div></div>

<h3 id="exporting-a-key">Exporting a Key</h3>

<p>Keys saved to disk without encryption are not secure as anyone who gets
ahold of the key may use it unless it is encrypted. In order to securely
export a key you may export it with a pass phrase.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'AES-128-CBC'</span>
<span class="n">pass_phrase</span> <span class="o">=</span> <span class="s1">'my secure pass phrase goes here'</span>

<span class="n">key_secure</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">export</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">pass_phrase</span>

<span class="nb">open</span> <span class="s1">'private.secure.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
  <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">key_secure</span>
<span class="k">end</span>
</code></pre></div></div>

<p>OpenSSL::Cipher.ciphers returns a list of available ciphers.</p>

<h3 id="loading-a-key">Loading a Key</h3>

<p>A key can also be loaded from a file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key2</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span> <span class="s1">'private_key.pem'</span>
<span class="n">key2</span><span class="p">.</span><span class="nf">public?</span> <span class="c1"># =&gt; true</span>
<span class="n">key2</span><span class="p">.</span><span class="nf">private?</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>or</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key3</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span> <span class="s1">'public_key.pem'</span>
<span class="n">key3</span><span class="p">.</span><span class="nf">public?</span> <span class="c1"># =&gt; true</span>
<span class="n">key3</span><span class="p">.</span><span class="nf">private?</span> <span class="c1"># =&gt; false</span>
</code></pre></div></div>

<h3 id="loading-an-encrypted-key">Loading an Encrypted Key</h3>

<p>OpenSSL will prompt you for your pass phrase when loading an encrypted
key. If you will not be able to type in the pass phrase you may provide
it when loading the key:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key4_pem</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span> <span class="s1">'private.secure.pem'</span>
<span class="n">pass_phrase</span> <span class="o">=</span> <span class="s1">'my secure pass phrase goes here'</span>
<span class="n">key4</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="n">key4_pem</span><span class="p">,</span> <span class="n">pass_phrase</span>
</code></pre></div></div>

<h2 id="rsa-encryption">RSA Encryption</h2>

<p>RSA provides encryption and decryption using the public and private
keys. You can use a variety of padding methods depending upon the
intended use of encrypted data.</p>

<h3 id="encryption--decryption">Encryption &amp; Decryption</h3>

<p>Asymmetric public/private key encryption is slow and victim to attack in
cases where it is used without padding or directly to encrypt larger
chunks of data. Typical use cases for RSA encryption involve “wrapping”
a symmetric key with the public key of the recipient who would “unwrap”
that symmetric key again using their private key. The following
illustrates a simplified example of such a key transport scheme. It
shouldn’t be used in practice, though, standardized protocols should
always be preferred.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wrapped_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">public_encrypt</span> <span class="n">key</span>
</code></pre></div></div>

<p>A symmetric key encrypted with the public key can only be decrypted with
the corresponding private key of the recipient.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">original_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">private_decrypt</span> <span class="n">wrapped_key</span>
</code></pre></div></div>

<p>By default PKCS#1 padding will be used, but it is also possible to use
other forms of padding, see PKey::RSA for further details.</p>

<h3 id="signatures">Signatures</h3>

<p>Using “private_encrypt” to encrypt some data with the private key is
equivalent to applying a digital signature to the data. A verifying
party may validate the signature by comparing the result of decrypting
the signature with “public_decrypt” to the original data. However,
OpenSSL::PKey already has methods “sign” and “verify” that handle
digital signatures in a standardized way - “private_encrypt” and
“public_decrypt” shouldn’t be used in practice.</p>

<p>To sign a document, a cryptographically secure hash of the document is
computed first, which is then signed using the private key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">digest</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">new</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">sign</span> <span class="n">digest</span><span class="p">,</span> <span class="n">document</span>
</code></pre></div></div>

<p>To validate the signature, again a hash of the document is computed and
the signature is decrypted using the public key. The result is then
compared to the hash just computed, if they are equal the signature was
valid.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">digest</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">new</span>
<span class="k">if</span> <span class="n">key</span><span class="p">.</span><span class="nf">verify</span> <span class="n">digest</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">document</span>
  <span class="nb">puts</span> <span class="s1">'Valid'</span>
<span class="k">else</span>
  <span class="nb">puts</span> <span class="s1">'Invalid'</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="pbkdf2-password-based-encryption">PBKDF2 Password-based Encryption</h2>

<p>If supported by the underlying OpenSSL version used, Password-based
Encryption should use the features of PKCS5. If not supported or if
required by legacy applications, the older, less secure methods
specified in RFC 2898 are also supported (see below).</p>

<p>PKCS5 supports PBKDF2 as it was specified in PKCS#5
<a href="http://www.rsa.com/rsalabs/node.asp?id=2127">v2.0</a>. It still uses a
password, a salt, and additionally a number of iterations that will slow
the key derivation process down. The slower this is, the more work it
requires being able to brute-force the resulting key.</p>

<h3 id="encryption">Encryption</h3>

<p>The strategy is to first instantiate a Cipher for encryption, and then
to generate a random IV plus a key derived from the password using
PBKDF2. PKCS #5 v2.0 recommends at least 8 bytes for the salt, the
number of iterations largely depends on the hardware being used.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cipher = OpenSSL::Cipher.new 'AES-128-CBC'
cipher.encrypt
iv = cipher.random_iv

pwd = 'some hopefully not to easily guessable password'
salt = OpenSSL::Random.random_bytes 16
iter = 20000
key_len = cipher.key_len
digest = OpenSSL::Digest::SHA256.new

key = OpenSSL::PKCS5.pbkdf2_hmac(pwd, salt, iter, key_len, digest)
cipher.key = key

Now encrypt the data:

encrypted = cipher.update document
encrypted &lt;&lt; cipher.final
</code></pre></div></div>

<h3 id="decryption">Decryption</h3>

<p>Use the same steps as before to derive the symmetric AES key, this time
setting the Cipher up for decryption.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cipher = OpenSSL::Cipher.new 'AES-128-CBC'
cipher.decrypt
cipher.iv = iv # the one generated with #random_iv

pwd = 'some hopefully not to easily guessable password'
salt = ... # the one generated above
iter = 20000
key_len = cipher.key_len
digest = OpenSSL::Digest::SHA256.new

key = OpenSSL::PKCS5.pbkdf2_hmac(pwd, salt, iter, key_len, digest)
cipher.key = key

Now decrypt the data:

decrypted = cipher.update encrypted
decrypted &lt;&lt; cipher.final
</code></pre></div></div>

<h2 id="pkcs-5-password-based-encryption">PKCS #5 Password-based Encryption</h2>

<p>PKCS #5 is a password-based encryption standard documented at
<a href="http://www.ietf.org/rfc/rfc2898.txt">RFC2898</a>. It allows a short
password or passphrase to be used to create a secure encryption key. If
possible, PBKDF2 as described above should be used if the circumstances
allow it.</p>

<p>PKCS #5 uses a Cipher, a pass phrase and a salt to generate an
encryption key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pass_phrase</span> <span class="o">=</span> <span class="s1">'my secure pass phrase goes here'</span>
<span class="n">salt</span> <span class="o">=</span> <span class="s1">'8 octets'</span>
</code></pre></div></div>

<h3 id="encryption-1">Encryption</h3>

<p>First set up the cipher for encryption</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encryptor</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'AES-128-CBC'</span>
<span class="n">encryptor</span><span class="p">.</span><span class="nf">encrypt</span>
<span class="n">encryptor</span><span class="p">.</span><span class="nf">pkcs5_keyivgen</span> <span class="n">pass_phrase</span><span class="p">,</span> <span class="n">salt</span>
</code></pre></div></div>

<p>Then pass the data you want to encrypt through</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encrypted</span> <span class="o">=</span> <span class="n">encryptor</span><span class="p">.</span><span class="nf">update</span> <span class="s1">'top secret document'</span>
<span class="n">encrypted</span> <span class="o">&lt;&lt;</span> <span class="n">encryptor</span><span class="p">.</span><span class="nf">final</span>
</code></pre></div></div>

<h3 id="decryption-1">Decryption</h3>

<p>Use a new Cipher instance set up for decryption</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">decryptor</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'AES-128-CBC'</span>
<span class="n">decryptor</span><span class="p">.</span><span class="nf">decrypt</span>
<span class="n">decryptor</span><span class="p">.</span><span class="nf">pkcs5_keyivgen</span> <span class="n">pass_phrase</span><span class="p">,</span> <span class="n">salt</span>
</code></pre></div></div>

<p>Then pass the data you want to decrypt through</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plain</span> <span class="o">=</span> <span class="n">decryptor</span><span class="p">.</span><span class="nf">update</span> <span class="n">encrypted</span>
<span class="n">plain</span> <span class="o">&lt;&lt;</span> <span class="n">decryptor</span><span class="p">.</span><span class="nf">final</span>
</code></pre></div></div>

<h2 id="x509-certificates">X509 Certificates</h2>

<h3 id="creating-a-certificate">Creating a Certificate</h3>

<p>This example creates a self-signed certificate using an RSA key and a
SHA1 signature.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="mi">2048</span>
<span class="nb">name</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">parse</span> <span class="s1">'CN=nobody/DC=example'</span>

<span class="n">cert</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="p">.</span><span class="nf">new</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">serial</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">not_before</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">not_after</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">3600</span>

<span class="n">cert</span><span class="p">.</span><span class="nf">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">public_key</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="nb">name</span>
</code></pre></div></div>

<h3 id="certificate-extensions">Certificate Extensions</h3>

<p>You can add extensions to the certificate with
OpenSSL::SSL::ExtensionFactory to indicate the purpose of the
certificate.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extension_factory</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">ExtensionFactory</span><span class="p">.</span><span class="nf">new</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">cert</span>

<span class="n">cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'basicConstraints'</span><span class="p">,</span> <span class="s1">'CA:FALSE'</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

<span class="n">cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span>
    <span class="s1">'keyUsage'</span><span class="p">,</span> <span class="s1">'keyEncipherment,dataEncipherment,digitalSignature'</span><span class="p">)</span>

<span class="n">cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'subjectKeyIdentifier'</span><span class="p">,</span> <span class="s1">'hash'</span><span class="p">)</span>
</code></pre></div></div>

<p>The list of supported extensions (and in some cases their possible
values) can be derived from the “objects.h” file in the OpenSSL source
code.</p>

<h3 id="signing-a-certificate">Signing a Certificate</h3>

<p>To sign a certificate set the issuer and use
OpenSSL::X509::<code class="highlighter-rouge">Certificate#sign</code> with a digest algorithm. This creates
a self-signed cert because we’re using the same name and key to sign the
certificate as was used to create the certificate.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cert</span><span class="p">.</span><span class="nf">issuer</span> <span class="o">=</span> <span class="nb">name</span>
<span class="n">cert</span><span class="p">.</span><span class="nf">sign</span> <span class="n">key</span><span class="p">,</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="p">.</span><span class="nf">new</span>

<span class="nb">open</span> <span class="s1">'certificate.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span> <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">cert</span><span class="p">.</span><span class="nf">to_pem</span> <span class="k">end</span>
</code></pre></div></div>

<h3 id="loading-a-certificate">Loading a Certificate</h3>

<p>Like a key, a cert can also be loaded from a file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cert2</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="p">.</span><span class="nf">new</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span> <span class="s1">'certificate.pem'</span>
</code></pre></div></div>

<h3 id="verifying-a-certificate">Verifying a Certificate</h3>

<p>Certificate#verify will return true when a certificate was signed with
the given public key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">raise</span> <span class="s1">'certificate can not be verified'</span> <span class="k">unless</span> <span class="n">cert2</span><span class="p">.</span><span class="nf">verify</span> <span class="n">key</span>
</code></pre></div></div>

<h2 id="certificate-authority">Certificate Authority</h2>

<p>A certificate authority (CA) is a trusted third party that allows you to
verify the ownership of unknown certificates. The CA issues key
signatures that indicate it trusts the user of that key. A user
encountering the key can verify the signature by using the CA’s public
key.</p>

<h3 id="ca-key">CA Key</h3>

<p>CA keys are valuable, so we encrypt and save it to disk and make sure it
is not readable by other users.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ca_key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span> <span class="mi">2048</span>
<span class="n">pass_phrase</span> <span class="o">=</span> <span class="s1">'my secure pass phrase goes here'</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'AES-128-CBC'</span>

<span class="nb">open</span> <span class="s1">'ca_key.pem'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="mo">0400</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
  <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">ca_key</span><span class="p">.</span><span class="nf">export</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">pass_phrase</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="ca-certificate">CA Certificate</h3>

<p>A CA certificate is created the same way we created a certificate above,
but with different extensions.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ca_name</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">parse</span> <span class="s1">'CN=ca/DC=example'</span>

<span class="n">ca_cert</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="p">.</span><span class="nf">new</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">serial</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">not_before</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">not_after</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">86400</span>

<span class="n">ca_cert</span><span class="p">.</span><span class="nf">public_key</span> <span class="o">=</span> <span class="n">ca_key</span><span class="p">.</span><span class="nf">public_key</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="n">ca_name</span>
<span class="n">ca_cert</span><span class="p">.</span><span class="nf">issuer</span> <span class="o">=</span> <span class="n">ca_name</span>

<span class="n">extension_factory</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">ExtensionFactory</span><span class="p">.</span><span class="nf">new</span>
<span class="n">extension_factory</span><span class="p">.</span><span class="nf">subject_certificate</span> <span class="o">=</span> <span class="n">ca_cert</span>
<span class="n">extension_factory</span><span class="p">.</span><span class="nf">issuer_certificate</span> <span class="o">=</span> <span class="n">ca_cert</span>

<span class="n">ca_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'subjectKeyIdentifier'</span><span class="p">,</span> <span class="s1">'hash'</span><span class="p">)</span>
</code></pre></div></div>

<p>This extension indicates the CA’s key may be used as a CA.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ca_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'basicConstraints'</span><span class="p">,</span> <span class="s1">'CA:TRUE'</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<p>This extension indicates the CA’s key may be used to verify signatures
on both certificates and certificate revocations.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ca_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span>
    <span class="s1">'keyUsage'</span><span class="p">,</span> <span class="s1">'cRLSign,keyCertSign'</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<p>Root CA certificates are self-signed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ca_cert</span><span class="p">.</span><span class="nf">sign</span> <span class="n">ca_key</span><span class="p">,</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>The CA certificate is saved to disk so it may be distributed to all the
users of the keys this CA will sign.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">open</span> <span class="s1">'ca_cert.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
  <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">ca_cert</span><span class="p">.</span><span class="nf">to_pem</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="certificate-signing-request">Certificate Signing Request</h3>

<p>The CA signs keys through a Certificate Signing Request (CSR). The CSR
contains the information necessary to identify the key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csr</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span>
<span class="n">csr</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">csr</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="nb">name</span>
<span class="n">csr</span><span class="p">.</span><span class="nf">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">public_key</span>
<span class="n">csr</span><span class="p">.</span><span class="nf">sign</span> <span class="n">key</span><span class="p">,</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>A CSR is saved to disk and sent to the CA for signing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">open</span> <span class="s1">'csr.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
  <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">csr</span><span class="p">.</span><span class="nf">to_pem</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="creating-a-certificate-from-a-csr">Creating a Certificate from a CSR</h3>

<p>Upon receiving a CSR the CA will verify it before signing it. A minimal
verification would be to check the CSR’s signature.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csr</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span> <span class="s1">'csr.pem'</span>

<span class="k">raise</span> <span class="s1">'CSR can not be verified'</span> <span class="k">unless</span> <span class="n">csr</span><span class="p">.</span><span class="nf">verify</span> <span class="n">csr</span><span class="p">.</span><span class="nf">public_key</span>
</code></pre></div></div>

<p>After verification a certificate is created, marked for various usages,
signed with the CA key and returned to the requester.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csr_cert</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="p">.</span><span class="nf">new</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">serial</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">not_before</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">not_after</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">600</span>

<span class="n">csr_cert</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="n">csr</span><span class="p">.</span><span class="nf">subject</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">public_key</span> <span class="o">=</span> <span class="n">csr</span><span class="p">.</span><span class="nf">public_key</span>
<span class="n">csr_cert</span><span class="p">.</span><span class="nf">issuer</span> <span class="o">=</span> <span class="n">ca_cert</span><span class="p">.</span><span class="nf">subject</span>

<span class="n">extension_factory</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">ExtensionFactory</span><span class="p">.</span><span class="nf">new</span>
<span class="n">extension_factory</span><span class="p">.</span><span class="nf">subject_certificate</span> <span class="o">=</span> <span class="n">csr_cert</span>
<span class="n">extension_factory</span><span class="p">.</span><span class="nf">issuer_certificate</span> <span class="o">=</span> <span class="n">ca_cert</span>

<span class="n">csr_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'basicConstraints'</span><span class="p">,</span> <span class="s1">'CA:FALSE'</span><span class="p">)</span>

<span class="n">csr_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span>
    <span class="s1">'keyUsage'</span><span class="p">,</span> <span class="s1">'keyEncipherment,dataEncipherment,digitalSignature'</span><span class="p">)</span>

<span class="n">csr_cert</span><span class="p">.</span><span class="nf">add_extension</span> <span class="p">\</span>
  <span class="n">extension_factory</span><span class="p">.</span><span class="nf">create_extension</span><span class="p">(</span><span class="s1">'subjectKeyIdentifier'</span><span class="p">,</span> <span class="s1">'hash'</span><span class="p">)</span>

<span class="n">csr_cert</span><span class="p">.</span><span class="nf">sign</span> <span class="n">ca_key</span><span class="p">,</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="p">.</span><span class="nf">new</span>

<span class="nb">open</span> <span class="s1">'csr_cert.pem'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
  <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">csr_cert</span><span class="p">.</span><span class="nf">to_pem</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="ssl-and-tls-connections">SSL and TLS Connections</h2>

<p>Using our created key and certificate we can create an SSL or TLS
connection. An SSLContext is used to set up an SSL session.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLContext</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<h3 id="ssl-server">SSL Server</h3>

<p>An SSL server requires the certificate and private key to communicate
securely with its clients:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="nf">cert</span> <span class="o">=</span> <span class="n">cert</span>
<span class="n">context</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="n">key</span>
</code></pre></div></div>

<p>Then create an SSLServer with a TCP server socket and the context. Use
the SSLServer like an ordinary TCP server.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'socket'</span>

<span class="n">tcp_server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span> <span class="mi">5000</span>
<span class="n">ssl_server</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLServer</span><span class="p">.</span><span class="nf">new</span> <span class="n">tcp_server</span><span class="p">,</span> <span class="n">context</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="n">ssl_connection</span> <span class="o">=</span> <span class="n">ssl_server</span><span class="p">.</span><span class="nf">accept</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span>

  <span class="n">response</span> <span class="o">=</span> <span class="s2">"I got </span><span class="si">#{</span><span class="n">data</span><span class="p">.</span><span class="nf">dump</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="n">response</span>

  <span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"I got </span><span class="si">#{</span><span class="n">data</span><span class="p">.</span><span class="nf">dump</span><span class="si">}</span><span class="s2">"</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="ssl-client">SSL client</h3>

<p>An SSL client is created with a TCP socket and the context.
<code class="highlighter-rouge">SSLSocket#connect</code> must be called to initiate the SSL handshake and
start encryption. A key and certificate are not required for the client
socket.</p>

<p>Note that <code class="highlighter-rouge">SSLSocket#close</code> doesn’t close the underlying socket by
default. Set S<code class="highlighter-rouge">SLSocket#sync_close</code> to true if you want.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'socket'</span>

<span class="n">tcp_socket</span> <span class="o">=</span> <span class="no">TCPSocket</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5000</span>
<span class="n">ssl_client</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLSocket</span><span class="p">.</span><span class="nf">new</span> <span class="n">tcp_socket</span><span class="p">,</span> <span class="n">context</span>
<span class="n">ssl_client</span><span class="p">.</span><span class="nf">sync_close</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">ssl_client</span><span class="p">.</span><span class="nf">connect</span>

<span class="n">ssl_client</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"hello server!"</span>
<span class="nb">puts</span> <span class="n">ssl_client</span><span class="p">.</span><span class="nf">gets</span>

<span class="n">ssl_client</span><span class="p">.</span><span class="nf">close</span> <span class="c1"># shutdown the TLS connection and close tcp_socket</span>
</code></pre></div></div>

<h3 id="peer-verification">Peer Verification</h3>

<p>An unverified SSL connection does not provide much security. For
enhanced security the client or server can verify the certificate of its
peer.</p>

<p>The client can be modified to verify the server’s certificate against
the certificate authority’s certificate:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="nf">ca_file</span> <span class="o">=</span> <span class="s1">'ca_cert.pem'</span>
<span class="n">context</span><span class="p">.</span><span class="nf">verify_mode</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_PEER</span>

<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="n">tcp_socket</span> <span class="o">=</span> <span class="no">TCPSocket</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5000</span>
<span class="n">ssl_client</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLSocket</span><span class="p">.</span><span class="nf">new</span> <span class="n">tcp_socket</span><span class="p">,</span> <span class="n">context</span>
<span class="n">ssl_client</span><span class="p">.</span><span class="nf">connect</span>

<span class="n">ssl_client</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"hello server!"</span>
<span class="nb">puts</span> <span class="n">ssl_client</span><span class="p">.</span><span class="nf">gets</span>
</code></pre></div></div>

<p>If the server certificate is invalid or <code class="highlighter-rouge">context.ca_file</code> is not set
when verifying peers an OpenSSL::SSL::SSLError will be raised.</p>

<p><a href="https://ruby-doc.org/stdlib-2.5.0/libdoc/openssl/rdoc/OpenSSL.html">OpenSSL
Reference</a></p>



                <!-- Mobile navigation buttons -->


                <!--
                    <a href="cli/cli-tool.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                 -->

            </div>



               <!--
                <a href="cli/cli-tool.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
                 -->

        </div>


        <script src="/js/book.js"></script>
    </body>
</html>
