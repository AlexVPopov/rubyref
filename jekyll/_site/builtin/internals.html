


<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title> | </title>

        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/highlight.css">
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='/jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body>
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter">

              
              <li>
                <a href="/about-this-book.html"> About This Book</a>
              </li>
                
              
              <li>
                <a href="/language.html"> Language Structure</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/language/keywords.html"> Keywords</a>
                          </li>
                        
                          <li>
                            <a href="/language/literals.html"> Literals</a>
                          </li>
                        
                          <li>
                            <a href="/language/variables-constants.html"> Variables and Constants</a>
                          </li>
                        
                          <li>
                            <a href="/language/assignment.html"> Assignment</a>
                          </li>
                        
                          <li>
                            <a href="/language/control-expressions.html"> Control Expressions</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-def.html"> Defining methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-call.html"> Calling methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/modules-classes.html"> Modules and Classes</a>
                          </li>
                        
                          <li>
                            <a href="/language/exceptions.html"> Exceptions</a>
                          </li>
                        
                          <li>
                            <a href="/language/refinements.html"> Refinements</a>
                          </li>
                        
                          <li>
                            <a href="/language/precedence.html"> Precedence</a>
                          </li>
                        
                          <li>
                            <a href="/language/files.html"> File Structure</a>
                          </li>
                        
                          <li>
                            <a href="/language/globals.html"> Globals</a>
                          </li>
                        
                          <li>
                            <a href="/language/metaprogramming.html"> Metaprogramming</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/builtin.html"> Built-in Classes</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/builtin/core.html"> Language Core</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/types.html"> Value Types</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/errors-warnings.html"> Errors and Warnings</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/system-cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/concurrency-parallelism.html"> Concurrency and Parallelism</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/internals.html"> Interpreter Internals</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/marshal.html"> Marshal</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/random.html"> Random</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/stdlib.html"> Standard Library</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/stdlib/patterns.html"> Design Patterns</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/formats.html"> Formats</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/development-debugging.html"> Development and Debugging</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/string-utilities.html"> String Utilities</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/networking-web.html"> Networking and Web</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cryptography-encoding.html"> Cryptography and Encoding</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/misc.html"> Miscellaneous Libraries</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/advanced-topics.html"> Advanced Topics</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/advanced-topics/third-party-libraries.html"> Third-Party Libraries</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/tools-approaches.html"> Tools and Approaches</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/contributing.html"> Contributing To Ruby</a>
                          </li>
                        
                    </ul>
                
              

            </ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                 <h1 id="interpreter-internals">Interpreter Internals</h1>

<p>This chapter lists several modules that allow to introspect and hack
Ruby interpreter at execution time.</p>

<h2 id="objectspace">ObjectSpace</h2>

<p>The ObjectSpace module contains a number of routines that interact with
the garbage collection facility and allow you to traverse all living
objects with an iterator.</p>

<p>ObjectSpace also provides support for object finalizers, procs that will
be called when a specific object is about to be destroyed by garbage
collection.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'objspace'</span>

<span class="n">a</span> <span class="o">=</span> <span class="s2">"A"</span>
<span class="n">b</span> <span class="o">=</span> <span class="s2">"B"</span>

<span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">define_finalizer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="nb">id</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Finalizer one on </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span> <span class="p">})</span>
<span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">define_finalizer</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="nb">id</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Finalizer two on </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span> <span class="p">})</span>
</code></pre></div></div>

<p><em>produces:</em></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Finalizer</span> <span class="n">two</span> <span class="n">on</span> <span class="mi">537763470</span>
<span class="no">Finalizer</span> <span class="n">one</span> <span class="n">on</span> <span class="mi">537763480</span>
</code></pre></div></div>

<p><a href="http://ruby-doc.org/core-2.5.0/ObjectSpace.html">ObjectSpace Reference</a></p>

<h3 id="objspace-standard-library">objspace standard library</h3>

<p>Standard library <code class="highlighter-rouge">objspace</code> provides some extensions for <code class="highlighter-rouge">ObjectSpace</code>
module.</p>

<p>The objspace library extends the ObjectSpace module and adds several
methods to get internal statistic information about object/memory
management.</p>

<p>You need to <code class="highlighter-rouge">require </code>objspace’` to use this extension module.</p>

<p>Generally, you <em>SHOULD NOT</em> use this library if you do not know about
the MRI implementation. Mainly, this library is for (memory) profiler
developers and MRI developers who need to know about MRI memory usage.</p>

<p><a href="https://ruby-doc.org/stdlib-2.5.0/libdoc/objspace/rdoc/ObjectSpace.html">ObjectSpace
Reference</a></p>

<h2 id="gc">GC</h2>

<p>The GC module provides an interface to Ruby’s mark and sweep garbage
collection mechanism.</p>

<p>Some of the underlying methods are also available via the ObjectSpace
module.</p>

<p>You may obtain information about the operation of the GC through
GC::Profiler.</p>

<p><a href="http://ruby-doc.org/core-2.5.0/GC.html">GC Reference</a></p>

<h2 id="tracepoint">TracePoint</h2>

<p>A class that provides the functionality of <code class="highlighter-rouge">Kernel#set_trace_func</code> in a
nice Object-Oriented API.</p>

<h3 id="example">Example</h3>

<p>We can use TracePoint to gather information specifically for exceptions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trace</span> <span class="o">=</span> <span class="no">TracePoint</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:raise</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">tp</span><span class="o">|</span>
    <span class="nb">p</span> <span class="p">[</span><span class="n">tp</span><span class="p">.</span><span class="nf">lineno</span><span class="p">,</span> <span class="n">tp</span><span class="p">.</span><span class="nf">event</span><span class="p">,</span> <span class="n">tp</span><span class="p">.</span><span class="nf">raised_exception</span><span class="p">]</span>
<span class="k">end</span>
<span class="c1">#=&gt; #&lt;TracePoint:disabled&gt;</span>

<span class="n">trace</span><span class="p">.</span><span class="nf">enable</span>
<span class="c1">#=&gt; false</span>

<span class="mi">0</span> <span class="o">/</span> <span class="mi">0</span>
<span class="c1">#=&gt; [5, :raise, #&lt;ZeroDivisionError: divided by 0&gt;]</span>
</code></pre></div></div>

<h3 id="events">Events</h3>

<p>If you don’t specify the type of events you want to listen for,
TracePoint will include all available events.</p>

<p><strong>Note</strong> do not depend on current event set, as this list is subject to
change. Instead, it is recommended you specify the type of events you
want to use.</p>

<p>To filter what is traced, you can pass any of the following as
<code class="highlighter-rouge">events</code>:</p>
<ul>
  <li><code class="highlighter-rouge">:line</code>: execute code on a new line</li>
  <li><code class="highlighter-rouge">:class</code>: start a class or module definition</li>
  <li><code class="highlighter-rouge">:end</code>: finish a class or module definition</li>
  <li><code class="highlighter-rouge">:call</code>: call a Ruby method</li>
  <li><code class="highlighter-rouge">:return</code>: return from a Ruby method</li>
  <li><code class="highlighter-rouge">:c_call</code>: call a C-language routine</li>
  <li><code class="highlighter-rouge">:c_return</code>: return from a C-language routine</li>
  <li><code class="highlighter-rouge">:raise</code>: raise an exception</li>
  <li><code class="highlighter-rouge">:b_call</code>: event hook at block entry</li>
  <li><code class="highlighter-rouge">:b_return</code>: event hook at block ending</li>
  <li><code class="highlighter-rouge">:thread_begin</code>: event hook at thread beginning</li>
  <li><code class="highlighter-rouge">:thread_end</code>: event hook at thread ending</li>
  <li><code class="highlighter-rouge">:fiber_switch</code>: event hook at fiber switch</li>
</ul>

<p><a href="http://ruby-doc.org/core-2.5.0/TracePoint.html">TracePoint Reference</a></p>



                <!-- Mobile navigation buttons -->


                <!--
                    <a href="cli/cli-tool.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                 -->

            </div>



               <!--
                <a href="cli/cli-tool.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
                 -->

        </div>


        <script src="/js/book.js"></script>
    </body>
</html>
