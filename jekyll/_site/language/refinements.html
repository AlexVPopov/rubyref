


<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title> | </title>

        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/highlight.css">
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='/jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body>
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter">

              
              <li>
                <a href="/about-this-book.html"> About This Book</a>
              </li>
                
              
              <li>
                <a href="/language.html"> Language Structure</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/language/keywords.html"> Keywords</a>
                          </li>
                        
                          <li>
                            <a href="/language/literals.html"> Literals</a>
                          </li>
                        
                          <li>
                            <a href="/language/variables-constants.html"> Variables and Constants</a>
                          </li>
                        
                          <li>
                            <a href="/language/assignment.html"> Assignment</a>
                          </li>
                        
                          <li>
                            <a href="/language/control-expressions.html"> Control Expressions</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-def.html"> Defining methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/methods-call.html"> Calling methods</a>
                          </li>
                        
                          <li>
                            <a href="/language/modules-classes.html"> Modules and Classes</a>
                          </li>
                        
                          <li>
                            <a href="/language/exceptions.html"> Exceptions</a>
                          </li>
                        
                          <li>
                            <a href="/language/refinements.html"> Refinements</a>
                          </li>
                        
                          <li>
                            <a href="/language/precedence.html"> Precedence</a>
                          </li>
                        
                          <li>
                            <a href="/language/files.html"> File Structure</a>
                          </li>
                        
                          <li>
                            <a href="/language/globals.html"> Globals</a>
                          </li>
                        
                          <li>
                            <a href="/language/metaprogramming.html"> Metaprogramming</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/builtin.html"> Built-in Classes</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/builtin/core.html"> Language Core</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/types.html"> Value Types</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/errors-warnings.html"> Errors and Warnings</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/system-cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/concurrency-parallelism.html"> Concurrency and Parallelism</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/internals.html"> Interpreter Internals</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/marshal.html"> Marshal</a>
                          </li>
                        
                          <li>
                            <a href="/builtin/random.html"> Random</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/stdlib.html"> Standard Library</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/stdlib/patterns.html"> Design Patterns</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/formats.html"> Formats</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/development-debugging.html"> Development and Debugging</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/string-utilities.html"> String Utilities</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/networking-web.html"> Networking and Web</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cli.html"> System Programming and CLI</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/cryptography-encoding.html"> Cryptography and Encoding</a>
                          </li>
                        
                          <li>
                            <a href="/stdlib/misc.html"> Miscellaneous Libraries</a>
                          </li>
                        
                    </ul>
                
              
              <li>
                <a href="/advanced-topics.html"> Advanced Topics</a>
              </li>
                
                    <ul class="section">
                        
                          <li>
                            <a href="/advanced-topics/third-party-libraries.html"> Third-Party Libraries</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/tools-approaches.html"> Tools and Approaches</a>
                          </li>
                        
                          <li>
                            <a href="/advanced-topics/contributing.html"> Contributing To Ruby</a>
                          </li>
                        
                    </ul>
                
              

            </ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                 <h1 id="refinements">Refinements</h1>

<p>Due to Ruby’s open classes you can redefine or add functionality to
existing classes. This is called a “monkey patch”. Unfortunately the
scope of such changes is global. All users of the monkey-patched class
see the same changes. This can cause unintended side-effects or breakage
of programs.</p>

<p>Refinements are designed to reduce the impact of monkey patching on
other users of the monkey-patched class. Refinements provide a way to
extend a class locally.</p>

<p>Here is a basic refinement:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="nb">puts</span> <span class="s2">"C#foo"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">M</span>
  <span class="n">refine</span> <span class="no">C</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">foo</span>
      <span class="nb">puts</span> <span class="s2">"C#foo in M"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>First, a class <code class="highlighter-rouge">C</code> is defined. Next a refinement for <code class="highlighter-rouge">C</code> is created
using Module#refine. Refinements can modify both classes and modules.</p>

<p>Module#refine creates an anonymous module that contains the changes or
refinements to the class (<code class="highlighter-rouge">C</code> in the example). <code class="highlighter-rouge">self</code> in the refine
block is this anonymous module similar to <code class="highlighter-rouge">Module#module_eval</code>.</p>

<p>Activate the refinement with <code class="highlighter-rouge">#using</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">using</span> <span class="no">M</span>

<span class="n">c</span> <span class="o">=</span> <span class="no">C</span><span class="p">.</span><span class="nf">new</span>

<span class="n">c</span><span class="p">.</span><span class="nf">foo</span> <span class="c1"># prints "C#foo in M"</span>
</code></pre></div></div>

<h2 id="scope">Scope</h2>

<p>You may activate refinements at top-level, and inside classes and
modules. You may not activate refinements in method scope. Refinements
are activated until the end of the current class or module definition,
or until the end of the current file if used at the top-level.</p>

<p>You may activate refinements in a string passed to <code class="highlighter-rouge">Kernel#eval</code>.
Refinements are active until the end of the eval string.</p>

<p>Refinements are lexical in scope. Refinements are only active within a
scope after the call to <code class="highlighter-rouge">using</code>. Any code before the <code class="highlighter-rouge">using</code> statement
will not have the refinement activated.</p>

<p>When control is transferred outside the scope, the refinement is
deactivated. This means that if you require or load a file or call a
method that is defined outside the current scope the refinement will be
deactivated:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">M</span>
  <span class="n">refine</span> <span class="no">C</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">foo</span>
      <span class="nb">puts</span> <span class="s2">"C#foo in M"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">foo</span>
<span class="k">end</span>

<span class="n">using</span> <span class="no">M</span>

<span class="n">x</span> <span class="o">=</span> <span class="no">C</span><span class="p">.</span><span class="nf">new</span>
<span class="n">x</span><span class="p">.</span><span class="nf">foo</span>       <span class="c1"># prints "C#foo in M"</span>
<span class="n">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1">#=&gt; raises NoMethodError</span>
</code></pre></div></div>

<p>If a method is defined in a scope where a refinement is active, the
refinement will be active when the method is called. This example spans
multiple files:</p>

<p>c.rb:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span>
<span class="k">end</span>
</code></pre></div></div>

<p>m.rb:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"c"</span>

<span class="k">module</span> <span class="nn">M</span>
  <span class="n">refine</span> <span class="no">C</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">foo</span>
      <span class="nb">puts</span> <span class="s2">"C#foo in M"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>m_user.rb:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"m"</span>

<span class="n">using</span> <span class="no">M</span>

<span class="k">class</span> <span class="nc">MUser</span>
  <span class="k">def</span> <span class="nf">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">foo</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>main.rb:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"m_user"</span>

<span class="n">x</span> <span class="o">=</span> <span class="no">C</span><span class="p">.</span><span class="nf">new</span>
<span class="n">m_user</span> <span class="o">=</span> <span class="no">MUser</span><span class="p">.</span><span class="nf">new</span>
<span class="n">m_user</span><span class="p">.</span><span class="nf">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># prints "C#foo in M"</span>
<span class="n">x</span><span class="p">.</span><span class="nf">foo</span>              <span class="c1">#=&gt; raises NoMethodError</span>
</code></pre></div></div>

<p>Since the refinement <code class="highlighter-rouge">M</code> is active in <code class="highlighter-rouge">m_user.rb</code> where <code class="highlighter-rouge">MUser#call_foo</code>
is defined it is also active when <code class="highlighter-rouge">main.rb</code> calls <code class="highlighter-rouge">call_foo</code>.</p>

<p>Since <code class="highlighter-rouge">#using</code> is a method, refinements are only active when it is
called. Here are examples of where a refinement <code class="highlighter-rouge">M</code> is and is not
active.</p>

<p>In a file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># not activated here</span>
<span class="n">using</span> <span class="no">M</span>
<span class="c1"># activated here</span>
<span class="k">class</span> <span class="nc">Foo</span>
  <span class="c1"># activated here</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="c1"># activated here</span>
  <span class="k">end</span>
  <span class="c1"># activated here</span>
<span class="k">end</span>
<span class="c1"># activated here</span>
</code></pre></div></div>

<p>In a class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># not activated here</span>
<span class="k">class</span> <span class="nc">Foo</span>
  <span class="c1"># not activated here</span>
  <span class="k">def</span> <span class="nf">foo</span>
    <span class="c1"># not activated here</span>
  <span class="k">end</span>
  <span class="n">using</span> <span class="no">M</span>
  <span class="c1"># activated here</span>
  <span class="k">def</span> <span class="nf">bar</span>
    <span class="c1"># activated here</span>
  <span class="k">end</span>
  <span class="c1"># activated here</span>
<span class="k">end</span>
<span class="c1"># not activated here</span>
</code></pre></div></div>

<p>Note that the refinements in <code class="highlighter-rouge">M</code> are <strong>not</strong> activated automatically if
the class <code class="highlighter-rouge">Foo</code> is reopened later.</p>

<p>In eval:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># not activated here</span>
<span class="nb">eval</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  # not activated here
  using M
  # activated here
</span><span class="no">EOF</span>
<span class="c1"># not activated here</span>
</code></pre></div></div>

<p>When not evaluated:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># not activated here</span>
<span class="k">if</span> <span class="kp">false</span>
  <span class="n">using</span> <span class="no">M</span>
<span class="k">end</span>
<span class="c1"># not activated here</span>
</code></pre></div></div>

<p>When defining multiple refinements in the same module inside multiple
<code class="highlighter-rouge">refine</code> blocks, all refinements from the same module are active when a
refined method (any of the <code class="highlighter-rouge">to_json</code> methods from the example below) is
called:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ToJSON</span>
  <span class="n">refine</span> <span class="no">Integer</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_json</span>
      <span class="nb">to_s</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">refine</span> <span class="no">Array</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_json</span>
      <span class="s2">"["</span> <span class="o">+</span> <span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="p">.</span><span class="nf">to_json</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"]"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">refine</span> <span class="no">Hash</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_json</span>
      <span class="s2">"{"</span> <span class="o">+</span> <span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">k</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">dump</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">v</span><span class="p">.</span><span class="nf">to_json</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"}"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">using</span> <span class="no">ToJSON</span>

<span class="nb">p</span> <span class="p">[{</span><span class="mi">1</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">}].</span><span class="nf">to_json</span> <span class="c1"># prints "[{\"1\":2},{\"3\":4}]"</span>
</code></pre></div></div>

<h2 id="method-lookup">Method Lookup</h2>

<p>When looking up a method for an instance of class <code class="highlighter-rouge">C</code> Ruby checks:</p>

<ul>
  <li>If refinements are active for <code class="highlighter-rouge">C</code>, in the reverse order they were
activated:
    <ul>
      <li>The prepended modules from the refinement for <code class="highlighter-rouge">C</code></li>
      <li>The refinement for <code class="highlighter-rouge">C</code></li>
      <li>The included modules from the refinement for <code class="highlighter-rouge">C</code></li>
    </ul>
  </li>
  <li>The prepended modules of <code class="highlighter-rouge">C</code></li>
  <li><code class="highlighter-rouge">C</code></li>
  <li>The included modules of <code class="highlighter-rouge">C</code></li>
</ul>

<p>If no method was found at any point this repeats with the superclass of
<code class="highlighter-rouge">C</code>.</p>

<p>Note that methods in a subclass have priority over refinements in a
superclass. For example, if the method <code class="highlighter-rouge">/</code> is defined in a refinement
for Numeric <code class="highlighter-rouge">1 / 2</code> invokes the original Integer#/ because Integer is a
subclass of Numeric and is searched before the refinements for the
superclass Numeric. Since the method <code class="highlighter-rouge">/</code> is also present in child
<code class="highlighter-rouge">Integer</code>, the method lookup does not move up to the superclass.</p>

<p>However, if a method <code class="highlighter-rouge">foo</code> is defined on Numeric in a refinement,
<code class="highlighter-rouge">1.foo</code> invokes that method since <code class="highlighter-rouge">foo</code> does not exist on Integer.</p>

<h2 id="super"><code class="highlighter-rouge">super</code></h2>

<p>When <code class="highlighter-rouge">super</code> is invoked method lookup checks:</p>

<ul>
  <li>
    <p>The included modules of the current class. Note that the current class
may be a refinement.</p>
  </li>
  <li>
    <p>If the current class is a refinement, the method lookup proceeds as in
the Method Lookup section above.</p>
  </li>
  <li>
    <p>If the current class has a direct superclass, the method proceeds as
in the Method Lookup section above using the superclass.</p>
  </li>
</ul>

<p>Note that <code class="highlighter-rouge">super</code> in a method of a refinement invokes the method in the
refined class even if there is another refinement which has been
activated in the same context.</p>

<h2 id="indirect-method-calls">Indirect Method Calls</h2>

<p>When using indirect method access such as <code class="highlighter-rouge">Kernel#send</code>, <code class="highlighter-rouge">Kernel#method</code>
or Kernel#respond_to? refinements are not honored for the caller
context during method lookup.</p>

<p>This behavior may be changed in the future.</p>

<h2 id="refinement-inheritance-by-moduleinclude">Refinement inheritance by <code class="highlighter-rouge">Module#include</code></h2>

<p>When a module X is included into a module Y, Y inherits refinements from
X.</p>

<p>For example, C inherits refinements from A and B in the following code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module A
  refine X do ... end
  refine Y do ... end
end
module B
  refine Z do ... end
end
module C
  include A
  include B
end

using C
# Refinements in A and B are activated here.
</code></pre></div></div>

<p>Refinements in descendants have higher precedence than those of
ancestors.</p>

<h2 id="further-reading">Further Reading</h2>

<p>See https://bugs.ruby-lang.org/projects/ruby-trunk/wiki/RefinementsSpec
for the current specification for implementing refinements. The
specification also contains more details.</p>



                <!-- Mobile navigation buttons -->


                <!--
                    <a href="cli/cli-tool.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                 -->

            </div>



               <!--
                <a href="cli/cli-tool.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
                 -->

        </div>


        <script src="/js/book.js"></script>
    </body>
</html>
